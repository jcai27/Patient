<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persona Chatbot - RAG + Multi-Agent System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background: #f5f5f5;
            border: none;
            font-size: 1.1em;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover {
            background: #e8e8e8;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 40px;
        }

        .tab-content.active {
            display: block;
        }

        /* Upload Section */
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px;
            text-align: center;
            background: #f9f9f9;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            background: #f0f0f0;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8f0ff;
            border-color: #667eea;
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 10px;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .status.processing {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Chat Section */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
        }

        .persona-selector {
            padding: 15px;
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
        }

        .persona-selector select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 18px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .message-info {
            font-size: 0.85em;
            color: #999;
            margin-top: 5px;
            padding: 0 5px;
        }

        .citations {
            margin-top: 10px;
            font-size: 0.9em;
            color: #667eea;
            font-weight: 600;
        }

        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 2px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-btn {
            padding: 12px 30px;
            border-radius: 25px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Persona Chatbot</h1>
            <p>RAG + Multi-Agent Orchestration System</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">üì§ Upload Transcript</button>
            <button class="tab" onclick="switchTab('chat')">üí¨ Chat</button>
        </div>

        <!-- Upload Tab -->
        <div id="upload-tab" class="tab-content active">
            <h2>Upload & Ingest Transcript</h2>
            <p style="color: #666; margin-bottom: 30px;">
                Upload a transcript file to create a persona. The system will extract facts, generate a profile, and build the knowledge base.
            </p>

            <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text">Click or drag & drop your transcript file here</div>
                <div style="color: #999; font-size: 0.9em;">Supports .txt files</div>
            </div>
            <input type="file" id="file-input" class="file-input" accept=".txt" />

            <div class="input-group" style="margin-top: 30px;">
                <label for="persona-name">Persona Name</label>
                <input type="text" id="persona-name" placeholder="e.g., VirtualHuman, Alice, Bob" value="VirtualHuman" />
            </div>

            <button class="btn" id="upload-btn" onclick="uploadTranscript()">üöÄ Start Ingestion</button>

            <div class="status" id="upload-status"></div>

            <div id="upload-stats" class="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-value" id="facts-count">0</div>
                    <div class="stat-label">Facts Extracted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="examples-count">0</div>
                    <div class="stat-label">Examples Generated</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="chunks-count">0</div>
                    <div class="stat-label">Chunks Created</div>
                </div>
            </div>
        </div>

        <!-- Chat Tab -->
        <div id="chat-tab" class="tab-content">
            <h2>Chat with Persona</h2>
            
            <div class="persona-selector">
                <label for="chat-persona">Select Persona:</label>
                <select id="chat-persona">
                    <option value="">Loading...</option>
                </select>
            </div>

            <div class="chat-container">
                <div class="messages" id="messages">
                    <div class="message assistant">
                        <div class="message-content">
                            üëã Hello! Select a persona to start chatting. If no personas are available, upload a transcript first.
                        </div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Type your message..." onkeypress="handleChatKeyPress(event)" />
                    <button class="btn send-btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let selectedPersona = null;
        const messagesDiv = document.getElementById('messages');
        const chatPersonaSelect = document.getElementById('chat-persona');
        const WELCOME_MESSAGE = 'üëã Hello! Select a persona to start chatting. If no personas are available, upload a transcript first.';

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // File upload handling
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                updateUploadPreview(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                updateUploadPreview(e.target.files[0]);
            }
        });

        function updateUploadPreview(file) {
            uploadArea.innerHTML = `
                <div class="upload-icon">üìÑ</div>
                <div class="upload-text"><strong>${file.name}</strong></div>
                <div style="color: #999; font-size: 0.9em;">${(file.size / 1024).toFixed(2)} KB</div>
            `;
        }

        async function uploadTranscript() {
            const fileInput = document.getElementById('file-input');
            const personaName = document.getElementById('persona-name').value.trim();
            const statusDiv = document.getElementById('upload-status');
            const uploadBtn = document.getElementById('upload-btn');

            if (!fileInput.files.length) {
                alert('Please select a file first!');
                return;
            }

            if (!personaName) {
                alert('Please enter a persona name!');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('persona_name', personaName);

            uploadBtn.disabled = true;
            uploadBtn.textContent = '‚è≥ Processing...';
            statusDiv.className = 'status processing';
            statusDiv.style.display = 'block';
            statusDiv.textContent = '‚è≥ Starting ingestion... This may take 2-5 minutes.';

            try {
                const response = await fetch('/upload/transcript', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Upload failed');
                }

                const result = await response.json();
                
                statusDiv.className = 'status success';
                statusDiv.textContent = `‚úÖ ${result.message}`;
                
                document.getElementById('facts-count').textContent = result.facts_count;
                document.getElementById('examples-count').textContent = result.examples_count;
                document.getElementById('upload-stats').style.display = 'grid';

                // Reload personas
                loadPersonas();
                
                // Switch to chat tab
                setTimeout(() => {
                    document.querySelector('.tab[onclick*="chat"]').click();
                }, 2000);

            } catch (error) {
                statusDiv.className = 'status error';
                statusDiv.textContent = `‚ùå Error: ${error.message}`;
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'üöÄ Start Ingestion';
            }
        }

        // Chat functionality
        function resetChatWindow(showWelcome = true) {
            messagesDiv.innerHTML = '';
            if (showWelcome) {
                addMessage(WELCOME_MESSAGE, 'assistant');
            }
        }

        function handlePersonaChange(event) {
            const personaName = event.target.value;
            selectedPersona = personaName || null;
            currentSessionId = null;

            if (!selectedPersona) {
                resetChatWindow(true);
                return;
            }

            resetChatWindow(false);
            addMessage(`üëã You are now chatting with ${selectedPersona}. Say hi to get started.`, 'assistant');

            fetch('/admin/persona/switch', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({persona_name: selectedPersona})
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error('Switch failed');
                }
                return res.json();
            })
            .catch(error => {
                console.error('Error switching persona:', error);
                addMessage('‚ö†Ô∏è Failed to switch persona. Please try again.', 'assistant');
            });
        }

        async function loadPersonas() {
            try {
                const response = await fetch('/personas');
                const data = await response.json();

                const previousSelection = selectedPersona;
                chatPersonaSelect.innerHTML = '<option value="">Select a persona...</option>';

                if (data.personas.length === 0) {
                    chatPersonaSelect.innerHTML = '<option value="">No personas available</option>';
                    selectedPersona = null;
                    currentSessionId = null;
                    resetChatWindow(true);
                    return;
                }

                let personaNames = [];
                data.personas.forEach(persona => {
                    const option = document.createElement('option');
                    option.value = persona.name;
                    option.textContent = persona.name;
                    chatPersonaSelect.appendChild(option);
                    personaNames.push(persona.name);
                });

                if (!chatPersonaSelect.dataset.listenerAttached) {
                    chatPersonaSelect.addEventListener('change', handlePersonaChange);
                    chatPersonaSelect.dataset.listenerAttached = 'true';
                }

                if (previousSelection && personaNames.includes(previousSelection)) {
                    chatPersonaSelect.value = previousSelection;
                    selectedPersona = previousSelection;
                } else {
                    selectedPersona = null;
                    currentSessionId = null;
                    resetChatWindow(true);
                }

            } catch (error) {
                console.error('Error loading personas:', error);
                addMessage('‚ö†Ô∏è Unable to load personas. Check the server status.', 'assistant');
            }
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            if (!selectedPersona) {
                alert('Please select a persona first!');
                return;
            }

            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';

            // Show loading
            const loadingId = addMessage('', 'assistant', { loading: true });
            const loadingEl = document.getElementById(loadingId);

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: 'web_user',
                        message: message,
                        session_id: currentSessionId
                    })
                });

                if (!response.ok) {
                    throw new Error('Chat failed');
                }

                const data = await response.json();
                
                // Update session ID
                if (data.session_id) {
                    currentSessionId = data.session_id;
                }

                // Remove loading message
                if (loadingEl) {
                    loadingEl.remove();
                }

                const infoText = formatScores(data.scores);
                addMessage(data.response, 'assistant', {
                    citations: data.citations || [],
                    infoText
                });

            } catch (error) {
                if (loadingEl) {
                    loadingEl.remove();
                }
                addMessage('‚ùå Error: ' + error.message, 'assistant');
            }
        }

        function formatScores(scores) {
            if (!scores || typeof scores !== 'object') {
                return '';
            }
            const labels = {
                factuality: 'F',
                persona: 'P',
                helpfulness: 'H',
                safety: 'S'
            };
            const parts = Object.keys(labels)
                .map(key => {
                    if (scores[key] === undefined || scores[key] === null) {
                        return null;
                    }
                    const value = Number(scores[key]);
                    if (!Number.isFinite(value)) {
                        return null;
                    }
                    return `${labels[key]}: ${value.toFixed(2)}`;
                })
                .filter(Boolean);
            return parts.length ? `Scores ¬∑ ${parts.join(' | ')}` : '';
        }

        function addMessage(content, type, options = {}) {
            const messageDiv = document.createElement('div');
            const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(16).slice(2);
            messageDiv.id = messageId;
            messageDiv.className = `message ${type}`;

            const messageContent = document.createElement('div');
            messageContent.className = 'message-content';

            if (options.loading) {
                messageContent.innerHTML = '<div class="loading"></div>';
            } else if (options.html) {
                messageContent.innerHTML = content;
            } else {
                messageContent.textContent = content;
            }

            if (options.citations && options.citations.length > 0) {
                const citationsDiv = document.createElement('div');
                citationsDiv.className = 'citations';
                citationsDiv.textContent = `üìö Sources: ${options.citations.join(', ')}`;
                messageContent.appendChild(citationsDiv);
            }

            messageDiv.appendChild(messageContent);

            if (options.infoText) {
                const infoDiv = document.createElement('div');
                infoDiv.className = 'message-info';
                infoDiv.textContent = options.infoText;
                messageDiv.appendChild(infoDiv);
            }

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            return messageId;
        }

        // Load personas on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadPersonas();
            if (messagesDiv.children.length === 0) {
                addMessage(WELCOME_MESSAGE, 'assistant');
            }
        });
    </script>
</body>
</html>

